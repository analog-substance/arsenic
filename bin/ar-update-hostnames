#! /bin/bash

function checkForAlias {
  while read domain; do
    aliases=$(grep -rP "\b$(echo $domain | sed 's/\./\\./g')\b" recon/domains/resolv-domains.txt | grep -P "alias" | awk '{print $1}' | sort -h | uniq | tr 'A-Z' 'a-z' | grep -viP "\b$(echo $domain | sed 's/\./\\./g')\b" )
    # if we have an alias, lets see if it has an alias
    if [ ! -z "$aliases" ] ; then
      for alias in $aliases; do
        echo $alias
      done | checkForAlias
    fi

    echo $domain
  done
}

function getDomainsForIP {
  ip="$1"
  {
    # grep -l "$ip" recon/domains/*/host.txt 2>/dev/null | xargs -n1 dirname 2>/dev/null| xargs -n1  basename 2>/dev/null
    grep -rP "\b$(echo $ip | sed 's/\./\\./g')\b" recon/domains/resolv-domains.txt | grep -P "address" | awk '{print $1}'
    cat hosts/$ip/recon/host.txt | grep pointer | awk '{print $NF}';
    cat hosts/$ip/recon/hostnames.txt;
    cat hosts/$ip/hostname;
    cat hosts/$ip/recon/ar-get-cert-domains.txt
    cat hosts/$ip/recon/hostnames.txt
    } 2>/dev/null | sed 's/^\*\.//g' | sed 's/\.$//g' | tr 'A-Z' 'a-z' | sort -h | uniq | checkForAlias
}

find hosts -name recon -print | while read d; do
  ip=$(echo $d | cut -d/ -f2);

  if [ ! -f hosts/$ip/recon/hostnames.txt ]; then
	  getDomainsForIP $ip | tee hosts/$ip/recon/hostnames.txt | while read hostname; do
      echo "[+] $ip $hostname"
    done
  fi

  if [ ! -f hosts/$ip/hostname ]; then
	  echo attempting to find hostname for $ip
	  hostname=$(cat hosts/$ip/recon/hostnames.txt | head -n1)
	  echo found $ip $hostname
    if [ "$hostname" != "" ]; then
      echo yay
  		echo $hostname >  hosts/$ip/hostname
  	else
  		echo no host found
    fi
  else
    cat hosts/$ip/hostname hosts/$ip/recon/hostnames.txt | sort -h | uniq > hosts/$ip/recon/hostnames.txt.new
    mv hosts/$ip/recon/hostnames.txt.new hosts/$ip/recon/hostnames.txt
  fi
  if [ ! -f $d/host.txt ]; then
    grep -rP "\b$(echo $ip | sed 's/\./\\./g')\b" recon/ips/resolv-ips.txt | sort -h | uniq | tee $d/host.txt
  fi;
done

ls hosts/*/recon/host.txt | while read d; do
  ip=$(echo $d | cut -d/ -f2);
  hostname=$(cat $d | grep pointer | head -n 1 | awk '{print $NF}');
  if [ ! -f hosts/$ip/hostname ]; then
    [[ "$hostname" != "" ]] && echo $hostname > hosts/$ip/hostname;
  fi
done

function getHostnames {
  ip="$1"
   {
    cat hosts/$ip/recon/host.txt | grep pointer | awk '{print $NF}';
    cat hosts/$ip/recon/hostnames.txt;
    cat hosts/$ip/hostname;
    cat hosts/$ip/recon/ar-get-cert-domains.txt
    cat hosts/$ip/recon/hostnames.txt
  } 2>/dev/null | sed 's/^\*\.//g' | sed 's/\.$//g' | tr 'A-Z' 'a-z' | sort -h | uniq | sed 's/^\(.\+\)$/"\1"/g'
}

function getRootDomains {
  ip="$1"
   {
    cat hosts/$ip/recon/host.txt | grep pointer | awk '{print $NF}';
    cat hosts/$ip/recon/hostnames.txt;
    cat hosts/$ip/hostname;
    cat hosts/$ip/recon/ar-get-cert-domains.txt
    cat hosts/$ip/recon/hostnames.txt
  } 2>/dev/null | grep -vP "([0-9]{1,3}\.){3}[0-9]{1,3}" | sed 's/^\*\.//g' | sed 's/\.$//g' | tr 'A-Z' 'a-z' | awk -F. '{print $(NF-1) "." $NF}' | sort -h | uniq | sed 's/^\(.\+\)$/"\1"/g'
}

find hosts -name recon -print | while read d; do
  ip=$(echo $d | cut -d/ -f2);
  hostnames=$( echo $(getHostnames "$ip") | sed 's/ /,/g')
  root_domains=$( echo $(getRootDomains "$ip") | sed 's/ /,/g')
  if [ ! -z "$hostnames" ]; then
    echo $ip
    echo "hostnames = [$hostnames]"
    echo "root_domains = [$root_domains]"

    if cat hosts/$ip/README.md | grep -P "^hostnames = \["; then
      # update existing
      cat hosts/$ip/README.md | sed 's/hostnames = \[.\+\]/hostnames = ['$hostnames']/' > hosts/$ip/README.md.new
      mv hosts/$ip/README.md.new hosts/$ip/README.md
    else
      if cat hosts/$ip/README.md | grep '+++' ; then
        # add to existing front matter
        cat hosts/$ip/README.md | sed '0,/+++/! {0,/+++/ s/+++/hostnames = ['$hostnames']\n+++/}'  > hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      else
        # no front matter found lets add it
        {
          echo "+++"
          echo "hostnames = [$hostnames]"
          echo "+++"
          echo
          cat hosts/$ip/README.md
        } > hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      fi
    fi

    if cat hosts/$ip/README.md | grep -P "^root_domains = \["; then
      # update existing
      cat hosts/$ip/README.md | sed 's/root_domains = \[.\+\]/root_domains = ['$root_domains']/' > hosts/$ip/README.md.new
      mv hosts/$ip/README.md.new hosts/$ip/README.md
    else
      if cat hosts/$ip/README.md | grep '+++' ; then
        # add to existing front matter
        cat hosts/$ip/README.md | sed '0,/+++/! {0,/+++/ s/+++/root_domains = ['$root_domains']\n+++/}'  > hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      else
        # no front matter?! where did it go we should have just added it if it didn't exist...
        echo "how did we get here? seriously! wtf!?"
      fi
    fi
  fi
done
