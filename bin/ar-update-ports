#! /bin/bash

ls hosts/*/recon/nmap-*.xml | awk -F '/' '{print $2}' | sort -u | while read ip; do
  ports=$(echo $(grep -v '<portused' hosts/$ip/recon/nmap-*.xml | grep -oP 'portid="[^"]*' | cut -d: -f2 | sed 's/portid="//g' | sort -h | uniq) | sed 's/ /,/g')
  new_ports="ports = [$ports]"

  if [ ! -z "$ports" ]; then
    existing_ports=$(cat hosts/$ip/README.md | grep -P "^ports = \[")
    if [ ! -z "$existing_ports" ] ; then
      # update existing
      if [ "$existing_ports" !=  "$new_ports" ] ; then
        echo updating $ip
        echo existing: $existing_ports
        echo new: $new_ports
        cat hosts/$ip/README.md | sed 's/ports = \[[0-9,]\+\]/'"$new_ports"'/' | tee hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      fi
      # echo skip > /dev/null
    else
      if cat hosts/$ip/README.md | grep '+++' >/dev/null ; then
        # add to existing front matter
        echo "[+] Add $ports for $ip"
        cat hosts/$ip/README.md | sed '0,/+++/! {0,/+++/ s/+++/'"$new_ports"'\n+++/}' > hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      else
        # no front matter found lets add it
        echo "[+] Creating README for $ip with $ports"

        {
          echo "+++"
          echo "$new_ports"
          echo "+++"
          echo
          cat hosts/$ip/README.md
        } > hosts/$ip/README.md.new
        mv hosts/$ip/README.md.new hosts/$ip/README.md
      fi
    fi
  fi
done
