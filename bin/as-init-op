#! /bin/bash

####
## BEGIN: Load common functions

if [ -z "$ARSENIC_PATH" ]; then
  pushd $(dirname $(dirname ${BASH_SOURCE[0]})) > /dev/null
  export ARSENIC_PATH=`pwd`
  popd > /dev/null
fi

if [ -f "$ARSENIC_PATH/etc/common.sh" ]; then
  source "$ARSENIC_PATH/etc/common.sh"
fi

## END: Load common functions
####

ARSENIC_OPT_PATH=$(dirname $ARSENIC_PATH)
OP_PATH="$OP_PATH"

set -euo pipefail

DEFAULT_OP="op"
OP_ARG=${1:-}

if [ ! -z "$OP_ARG" ]; then
  DEFAULT_OP="$OP_ARG"
fi

if [ -z "$OP_PATH" ]; then
  OP_PATH="$DEFAULT_OP"
fi

export OP_NAME=$(basename "$OP_PATH")

_ "Creating op: $OP_NAME"

mkdir -p "$OP_PATH"
cd "$OP_PATH"

if [ ! -d ".hugo" ]; then

  mkdir -p apps bin report/{findings,sections,static} hosts recon/domains
  touch {apps,bin,recon}/.keep report/static/.keep

  touch scope-domains.txt
  touch scope-ips.txt

  _ "Setup hugo"
  git clone https://github.com/defektive/arsenic-hugo.git

  rm -rf arsenic-hugo/.git
  mv arsenic-hugo/example .hugo
  mkdir .hugo/themes
  mv arsenic-hugo .hugo/themes/arsenic

  mv .hugo/README.md report/sections/
  ln -s report/sections/README.md

  cd .hugo
  mv config.toml ../
  ln -s ../config.toml
  mv sample-finding ../report/findings/first-finding

  cd content
  ln -srf ../../recon
  ln -srf ../../hosts
  ls -d ../../report/* | xargs -n 1 ln -srf

  _ "Hugo Setup complete"

  cd ../../

  if [ ! -f Makefile ]; then
    {
      echo -e "report::\n\tcd .hugo; \\"
      echo -e "\thugo server"
    } >> Makefile
  fi
fi

echo
ls -d $ARSENIC_OPT_PATH/*/scripts/as-init-op.sh 2>/dev/null


ls -d $ARSENIC_OPT_PATH/*/scripts/as-init-op.sh 2>/dev/null | while read hook; do
  _ "running $hook"
  bash "$hook"
done

_ "Hooks completed"

if [ -d .git ]; then
  _ "git found"
  if [ "$(git status --porcelain | wc -l)" -gt 0 ]; then
    _warn "git changes detected"
    git status
  fi

  echo
  _ "git clone $(cat .git/config | grep op.git | awk '{print $3}')"
fi



_ "as init complete"
